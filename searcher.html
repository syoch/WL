<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>WL Searcher</title>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.3.1/fuse.min.js"></script>

</head>

<body>
  <input type="text" id="target" onkeyup="search_handler()">
  <input type="button" value="検索" onclick="search_handler()">
  <table style="width: 90vw;" border="1">
    <thead>
      <th>WL番号</th>
      <th>起源</th>
      <th>内容</th>
    </thead>
    <tbody id="result">
    </tbody>
  </table>

  <script>
    // var fuse = new Fuse(list, options);

    class WL {
      constructor(arr) {
        this.wl_id = arr[0].toString();
        this.author = arr[1].toString();
        this.content = arr[2].toString();
      }

      toElement() {
        let row = $("<tr>");
        row.append($("<td>").text(this.wl_id));
        row.append($("<td>").text(this.author));
        row.append($("<td>").text(this.content));
        return row;
      }
    }


    function search_handler(target = "") {
      if (target == "") {
        target = $("#target").val();
      }

      let elem = $("#result");
      elem.empty();

      let matches =
        target == ""
          ? dict
          : fuse.search(target);

      for (let wl of matches) {
        elem.append(wl.toElement());
      }

    }


    $(() => {
      $.getJSON("/datas/database.json?" + Date().toString().replaceAll(/\D/g, ""), (data) => {
        window.dict = data.map(
          x => new WL(x)
        );

        window.fuse = new Fuse(window.dict, {
          keys: ["wl_id", "author", "content"],
          threshold: 0.6,
        })
      }).then(() => {
        search_handler("");
      });

    })
  </script>
</body>

</html>